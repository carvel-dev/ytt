// Copyright 2021 VMware, Inc.
// SPDX-License-Identifier: Apache-2.0

package schema

import (
	"fmt"

	"github.com/k14s/ytt/pkg/yamlmeta"
)

// keys used when generating an OpenAPI Document
const (
	typeProp        = "type"
	defaultProp     = "default"
	nullableProp    = "nullable"
	descriptionProp = "description"
	titleProp       = "title"
)

// OpenAPIDocument holds the document type used for creating an OpenAPI document
type OpenAPIDocument struct {
	docType *DocumentType
}

// NewOpenAPIDocument creates an instance of an OpenAPIDocument based on the given DocumentType
func NewOpenAPIDocument(docType *DocumentType) *OpenAPIDocument {
	return &OpenAPIDocument{docType}
}

// AsDocument generates a new AST of this OpenAPI v3.0.x document, populating the `schemas:` section with the
// type information contained in `docType`.
func (o *OpenAPIDocument) AsDocument() *yamlmeta.Document {
	openAPIProperties := o.calculateProperties(o.docType)

	return &yamlmeta.Document{Value: &yamlmeta.Map{Items: []*yamlmeta.MapItem{
		{Key: "openapi", Value: "3.0.0"},
		{Key: "info", Value: &yamlmeta.Map{Items: []*yamlmeta.MapItem{
			{Key: "version", Value: "0.1.0"},
			{Key: "title", Value: "Schema for data values, generated by ytt"},
		}}},
		{Key: "paths", Value: &yamlmeta.Map{}},
		{Key: "components", Value: &yamlmeta.Map{Items: []*yamlmeta.MapItem{
			{Key: "schemas", Value: &yamlmeta.Map{Items: []*yamlmeta.MapItem{
				{Key: "dataValues", Value: openAPIProperties},
			}}},
		}}},
	}}}
}

func (o *OpenAPIDocument) calculateProperties(schemaVal interface{}) *yamlmeta.Map {
	switch typedValue := schemaVal.(type) {
	case *DocumentType:
		return o.calculateProperties(typedValue.GetValueType())
	case *MapType:
		var properties []*yamlmeta.MapItem
		for _, i := range typedValue.Items {
			mi := yamlmeta.MapItem{Key: i.Key, Value: o.calculateProperties(i.GetValueType())}
			properties = append(properties, &mi)
		}
		var property yamlmeta.Map
		if typedValue.GetTitle() != "" {
			item := []*yamlmeta.MapItem{
				{Key: titleProp, Value: typedValue.GetTitle()},
			}
			property.Items = append(property.Items, item...)
		}
		property.Items = append(property.Items, &yamlmeta.MapItem{Key: typeProp, Value: "object"})
		property.Items = append(property.Items, &yamlmeta.MapItem{Key: "additionalProperties", Value: false})
		if typedValue.GetDescription() != "" {
			property.Items = append(property.Items, &yamlmeta.MapItem{Key: descriptionProp, Value: typedValue.GetDescription()})
		}
		property.Items = append(property.Items, &yamlmeta.MapItem{Key: "properties", Value: &yamlmeta.Map{Items: properties}})
		return &property
	case *ArrayType:
		valueType := typedValue.GetValueType().(*ArrayItemType)
		properties := o.calculateProperties(valueType.GetValueType())
		var property yamlmeta.Map
		if typedValue.GetTitle() != "" {
			item := []*yamlmeta.MapItem{
				{Key: titleProp, Value: typedValue.GetTitle()},
			}
			property.Items = append(property.Items, item...)
		}
		property.Items = append(property.Items, &yamlmeta.MapItem{Key: typeProp, Value: "array"})
		if typedValue.GetDescription() != "" {
			property.Items = append(property.Items, &yamlmeta.MapItem{Key: descriptionProp, Value: typedValue.GetDescription()})
		}
		property.Items = append(property.Items, &yamlmeta.MapItem{Key: "items", Value: properties})
		property.Items = append(property.Items, &yamlmeta.MapItem{Key: defaultProp, Value: typedValue.GetDefaultValue()})
		return &property
	case *ScalarType:
		typeString := o.openAPITypeFor(typedValue)
		defaultVal := typedValue.GetDefaultValue()
		var property yamlmeta.Map
		if typedValue.GetTitle() != "" {
			item := []*yamlmeta.MapItem{
				{Key: titleProp, Value: typedValue.GetTitle()},
			}
			property.Items = append(property.Items, item...)
		}
		property.Items = append(property.Items, &yamlmeta.MapItem{Key: typeProp, Value: typeString})
		property.Items = append(property.Items, &yamlmeta.MapItem{Key: defaultProp, Value: defaultVal})
		if typedValue.String() == "float" {
			property.Items = append(property.Items, &yamlmeta.MapItem{Key: "format", Value: "float"})
		}
		if typedValue.GetDescription() != "" {
			property.Items = append(property.Items, &yamlmeta.MapItem{Key: descriptionProp, Value: typedValue.GetDescription()})
		}
		return &property
	case *NullType:
		properties := o.calculateProperties(typedValue.GetValueType())
		if typedValue.GetTitle() != "" {
			items := []*yamlmeta.MapItem{
				{Key: titleProp, Value: typedValue.GetTitle()},
			}
			properties.Items = append(properties.Items, items...)
		}
		properties.Items = append(properties.Items, &yamlmeta.MapItem{Key: nullableProp, Value: true})
		if typedValue.GetDescription() != "" {
			properties.Items = append(properties.Items, &yamlmeta.MapItem{Key: descriptionProp, Value: typedValue.GetDescription()})
		}
		return properties
	case *AnyType:
		properties := &yamlmeta.Map{Items: []*yamlmeta.MapItem{}}
		if typedValue.GetTitle() != "" {
			item := []*yamlmeta.MapItem{
				{Key: titleProp, Value: typedValue.GetTitle()},
			}
			properties.Items = append(properties.Items, item...)
		}
		properties.Items = append(properties.Items, &yamlmeta.MapItem{Key: nullableProp, Value: true})
		properties.Items = append(properties.Items, &yamlmeta.MapItem{Key: defaultProp, Value: typedValue.GetDefaultValue()})
		if typedValue.GetDescription() != "" {
			properties.Items = append(properties.Items, &yamlmeta.MapItem{Key: descriptionProp, Value: typedValue.GetDescription()})
		}
		return properties
	default:
		panic(fmt.Sprintf("Unrecognized type %T", schemaVal))
	}
}

func (o *OpenAPIDocument) openAPITypeFor(astType *ScalarType) string {
	switch astType.ValueType {
	case StringType:
		return "string"
	case FloatType:
		return "number"
	case IntType:
		return "integer"
	case BoolType:
		return "boolean"
	default:
		panic(fmt.Sprintf("Unrecognized type: %T", astType.ValueType))
	}
}
